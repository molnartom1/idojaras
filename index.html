<!DOCTYPE html>
<html lang="hu" data-theme="auto">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Időjárás – Mobilbarát előrejelzés + Esőradar (PWA)</title>
<meta name="description" content="Egyoldalas, mobilbarát időjárás-előrejelzés esőradarral, PWA-ként telepíthető." />
<meta name="theme-color" content="#0f172a" />
<meta name="color-scheme" content="light dark" />
<link rel="manifest" id="manifest-link">
<style>
  :root{
    --bg:#0f172a; --card:#111827cc; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
    --ok:#34d399; --warn:#f59e0b; --danger:#f87171; --ring:#22d3ee55; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f1f5f9; --card:#ffffffea; --muted:#475569; --text:#0f172a; --accent:#0891b2;
      --ok:#059669; --warn:#d97706; --danger:#ef4444; --ring:#06b6d455;
    }
    :root[data-force="dark"]{ --bg:#0f172a; --card:#111827cc; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b; --danger:#f87171; --ring:#22d3ee55; }
  }
  :root[data-force="light"]{ --bg:#f1f5f9; --card:#ffffffea; --muted:#475569; --text:#0f172a; --accent:#0891b2; --ok:#059669; --warn:#d97706; --danger:#ef4444; --ring:#06b6d455; }
  :root[data-force="dark"]{ --bg:#0f172a; --card:#111827cc; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b; --danger:#f87171; --ring:#22d3ee55; }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
    background: radial-gradient(1200px 800px at 10% -10%, #22d3ee22, transparent 70%), radial-gradient(1000px 700px at 110% -10%, #a78bfa22, transparent 70%), var(--bg);
    color:var(--text); display:flex; justify-content:center; padding:clamp(14px,3vw,32px);
  }
  .app{ width:100%; max-width:1100px; display:grid; gap:16px; grid-template-columns:1fr; }
  header{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{ width:38px; height:38px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#a78bfa); display:grid; place-items:center; color:#001018; font-weight:800; box-shadow:var(--shadow) }
  h1{ margin:0; font-size:clamp(1.1rem,3.3vw,1.6rem); letter-spacing:.2px }
  .muted{ color:var(--muted) } .small{ font-size:.92rem }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; width:100%; align-items:center; }
  .search{ flex:1 1 280px; display:flex; gap:8px; align-items:center; background:var(--card); padding:8px; border-radius:14px; box-shadow:var(--shadow); border:1px solid transparent; }
  .search:focus-within{ outline:2px solid var(--ring); border-color:transparent }
  .search input{ flex:1; border:0; background:transparent; color:var(--text); font-size:16px; padding:10px; outline:none; }
  .btn{ border:0; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.2s transform ease,.2s background ease,.2s opacity ease; background:var(--accent); color:#001018; box-shadow:var(--shadow) }
  .btn:hover{ transform:translateY(-1px) }
  .btn.secondary{ background:#334155; color:#e5e7eb } @media (prefers-color-scheme: light){ .btn.secondary{ background:#e2e8f0; color:#0f172a } }
  .grid{ display:grid; gap:16px; grid-template-columns:1fr }
  @media (min-width:820px){ .grid{ grid-template-columns:1.1fr .9fr } }
  .card{ background:var(--card); border:1px solid #ffffff10; border-radius:var(--radius); box-shadow:var(--shadow); padding:16px }
  .current{ display:grid; grid-template-columns:auto 1fr; gap:16px; align-items:center }
  .bigtemp{ font-size:clamp(2.8rem,7vw,4.5rem); font-weight:800; letter-spacing:-1px }
  .desc{ font-size:1rem; text-transform:capitalize }
  .meta{ display:flex; gap:14px; flex-wrap:wrap; margin-top:8px }
  .chip{ background:#ffffff10; padding:8px 10px; border-radius:999px; font-size:.92rem; display:flex; gap:8px; align-items:center }
  .row{ display:flex; align-items:center; gap:8px }
  .scroll{ display:flex; gap:10px; overflow:auto; padding-bottom:6px; scroll-snap-type:x mandatory }
  .tile{ min-width:110px; scroll-snap-align:start; background:#ffffff10; border:1px solid #ffffff14; border-radius:14px; padding:12px; display:grid; gap:8px; place-items:center }
  .daygrid{ display:grid; gap:10px }
  .dayrow{ display:grid; grid-template-columns:1fr auto auto auto; gap:10px; align-items:center; padding:10px 12px; border-radius:12px; background:#ffffff10; border:1px solid #ffffff14 }
  .unit-toggle,.theme-toggle{ background:#ffffff10; border:1px solid #ffffff14; border-radius:12px; padding:4px; display:flex; gap:4px; align-items:center }
  .seg{ padding:6px 10px; border-radius:8px; cursor:pointer; user-select:none }
  .seg.active{ background:var(--accent); color:#001018; font-weight:700 }
  .badge{ font-size:.8rem; padding:.2rem .5rem; border-radius:999px; background:#ffffff10; border:1px solid #ffffff22 }
  .locline{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  .skeleton{ background:linear-gradient(90deg,#ffffff10,#ffffff22,#ffffff10); background-size:200% 100%; animation:shimmer 1.4s infinite; border-radius:10px; height:1em }
  @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .warn{ color:var(--warn) } .err{ color:var(--danger) } .ok{ color:var(--ok) }
  /* SVG ikonok színe fixen a szövegszín: */
  #currentIcon svg, .tile svg, .dayrow svg { color: var(--text); }

  /* --- RADAR --- */
  .map-card{ padding:0; overflow:hidden }
  .map-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px 12px 0 12px }
  .map{ position:relative; height:420px; background:#0b1220; touch-action:pinch-zoom pan-x pan-y; user-select:none; overflow:hidden; border-radius:0 0 var(--radius) var(--radius) }
  .map .layer{ position:absolute; top:0; left:0; transform-origin:0 0; image-rendering:crisp-edges; will-change:transform }
  .map .tile{ position:absolute; width:256px; height:256px; image-rendering:crisp-edges; }
  .map-controls{ position:absolute; right:10px; top:10px; display:grid; gap:6px }
  .ctrl{ background:#ffffff18; border:1px solid #ffffff30; backdrop-filter:blur(6px); padding:8px; border-radius:10px; cursor:pointer; font-weight:800 }
  .timeline{ position:absolute; left:50%; bottom:12px; transform:translateX(-50%); display:flex; gap:6px; align-items:center; background:#00000040; border:1px solid #ffffff30; padding:6px 10px; border-radius:999px; backdrop-filter:blur(6px) }
  .dot{ width:8px; height:8px; border-radius:999px; background:#ffffff55 }
  .dot.active{ background:var(--accent) }
  .time-label{ color:#fff; font-size:.9rem; margin-left:6px }
</style>
</head>
<body>
<div class="app" id="app" data-units="metric">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">⛅</div>
      <div>
        <h1>Időjárás előrejelzés</h1>
        <div class="muted small">Mobilbarát ikonokkal, esőradarral, PWA-val</div>
      </div>
    </div>
    <div class="row" style="gap:8px; flex-wrap:wrap">
      <div class="theme-toggle" role="tablist" aria-label="Téma">
        <button class="seg" id="themeAuto" role="tab">Auto</button>
        <button class="seg" id="themeLight" role="tab">Világos</button>
        <button class="seg" id="themeDark" role="tab">Sötét</button>
      </div>
      <div class="unit-toggle" role="tablist" aria-label="Mértékegység">
        <button class="seg active" id="unitC" role="tab" aria-selected="true">°C</button>
        <button class="seg" id="unitF" role="tab" aria-selected="false">°F</button>
      </div>
    </div>
  </header>

  <div class="toolbar">
    <label class="search" for="q">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21 20.3 17.2 16.5a8 8 0 1 0-1 1L20.3 21zM5 11a6 6 0 1 1 12 0A6 6 0 0 1 5 11"/></svg>
      <input id="q" type="search" placeholder="Város keresése (pl. Budapest)" autocomplete="off" />
      <button class="btn" id="searchBtn" type="button">Keresés</button>
    </label>
    <button class="btn secondary" id="geoBtn" type="button" title="Saját helyzetem">Saját helyzetem</button>
    <button class="btn secondary" id="installBtn" type="button" title="Telepítés (PWA)" class="hidden">Telepítés</button>
  </div>

  <section class="grid" id="content">
    <article class="card">
      <div class="current" id="current">
        <div id="currentIcon" aria-hidden="true"></div>
        <div>
          <div class="locline">
            <strong id="place">—</strong>
            <span class="badge" id="tz">—</span>
            <span class="badge" id="updated">Frissítés…</span>
          </div>
          <div class="bigtemp" id="temp">—°</div>
          <div class="desc" id="desc">—</div>
          <div class="meta" id="meta">
            <div class="chip"><span class="ico">🌡</span><span>Hőérzet: <b id="feels">—</b></span></div>
            <div class="chip"><span class="ico">💧</span><span>Páratartalom: <b id="humidity">—</b></span></div>
            <div class="chip"><span class="ico">🌬</span><span>Szél: <b id="wind">—</b></span></div>
            <div class="chip"><span class="ico">📈</span><span>Nyomás: <b id="pressure">—</b></span></div>
            <div class="chip"><span class="ico">🌅</span><span>Napkelte: <b id="sunrise">—</b></span></div>
            <div class="chip"><span class="ico">🌇</span><span>Napnyugta: <b id="sunset">—</b></span></div>
          </div>
        </div>
      </div>
    </article>

    <article class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <h3 style="margin:0">Következő órák</h3>
        <span class="muted small" id="hourlyRange">—</span>
      </div>
      <div class="scroll" id="hourly"></div>
    </article>

    <article class="card" style="grid-column:1/-1">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <h3 style="margin:0">7 napos előrejelzés</h3>
        <span class="muted small" id="dailyRange">—</span>
      </div>
      <div class="daygrid" id="daily"></div>
    </article>

    <!-- RADAR -->
    <article class="card map-card" style="grid-column:1/-1">
      <div class="map-toolbar">
        <h3 style="margin:0">Esőradar (RainViewer + OSM)</h3>
        <div class="row" style="gap:8px">
          <button class="btn secondary" id="radarPlay">Lejátszás</button>
          <button class="btn secondary" id="radarPause">Szünet</button>
          <button class="btn secondary" id="radarNow">Most</button>
        </div>
      </div>
      <div class="map" id="map">
        <div class="layer" id="baseLayer"></div>
        <div class="layer" id="radarLayer" style="opacity:.78"></div>
        <div class="map-controls">
          <button class="ctrl" id="zoomIn" aria-label="Nagyítás">＋</button>
          <button class="ctrl" id="zoomOut" aria-label="Kicsinyítés">－</button>
          <button class="ctrl" id="locate" aria-label="Ugrás a helyzetemre">📍</button>
        </div>
        <div class="timeline" id="timeline">
          <div class="row" id="dots"></div>
          <div class="time-label" id="timeLabel">—</div>
        </div>
      </div>
    </article>
  </section>

  <footer>
    Adatok: Open-Meteo • Radar: RainViewer • Térkép: OpenStreetMap • <span class="muted">Telepíthető PWA, offline keret</span>
  </footer>
</div>

<!-- Ikonok (WMO kódokhoz) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="i-clear-day" viewBox="0 0 24 24"><path fill="currentColor" d="M12 18a6 6 0 1 0 0-12a6 6 0 0 0 0 12m0-16h1v3h-1zM12 19h1v3h-1zM1 12h3v1H1zM20 12h3v1h-3zM4.6 4.6l.7-.7l2.1 2.1l-.7.7zM16.6 16.6l.7-.7l2.1 2.1l-.7.7zM16.6 6.7l2.1-2.1l.7.7l-2.1 2.1zM4.6 18.4l2.1-2.1l.7.7l-2.1 2.1z"/></symbol>
  <symbol id="i-clear-night" viewBox="0 0 24 24"><path fill="currentColor" d="M11.5 22q-3.8 0-6.4-2.6T2.5 13Q2.9 8 7 6q.2-.1.4.1t0 .4q-.4 1-.4 2.1q0 3.2 2.3 5.5T15 16.5q1.1 0 2.1-.4q.3-.1.5.1q.2.2.1.4q-1.1 4.1-5.1 5.4q-.6.1-1.1.1Z"/></symbol>
  <symbol id="i-cloud" viewBox="0 0 24 24"><path fill="currentColor" d="M7 19q-2.1 0-3.55-1.45T2 14q0-1.95 1.275-3.4T6.5 9.05Q7.55 6.3 9.913 4.65T15 3q3.35 0 5.675 2.162T23 10q0 2.925-2.037 4.963T16 17H7Z"/></symbol>
  <symbol id="i-cloud-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M7 19q-2.1 0-3.55-1.45T2 14q0-1.95 1.275-3.4T6.5 9.05Q7.55 6.3 9.913 4.65T15 3q2.35 0 4.205 1.325T22.7 7.5q-1.5-.7-3.2-.5Q17 7.2 15.6 8.3T13 11h-2q-1.85 0-3.425.913T5 14.5q-.25 2.05.5 3.75Q6.3 19 7 19Z"/></symbol>
  <symbol id="i-rain" viewBox="0 0 24 24"><path fill="currentColor" d="M6 14q-1.65 0-2.825-1.175T2 10q0-1.65 1.175-2.825T6 6q.95 0 1.8.4t1.45 1.1q.8-1 2-1.5T15 5q2.5 0 4.25 1.75T21 11q0 1.25-.487 2.35T18.9 15H6Zm2 7l2-3m4 3l2-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></symbol>
  <symbol id="i-shower" viewBox="0 0 24 24"><path fill="currentColor" d="M6 14q-1.65 0-2.825-1.175T2 10q0-1.65 1.175-2.825T6 6q.95 0 1.8.4t1.45 1.1q.8-1 2-1.5T15 5q2.5 0 4.25 1.75T21 11q0 1.25-.487 2.35T18.9 15H6Z"/><path d="M7 18l.8-1.2M10 20l.8-1.2M13 18l.8-1.2M16 20l.8-1.2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></symbol>
  <symbol id="i-thunder" viewBox="0 0 24 24"><path fill="currentColor" d="M6 14q-1.65 0-2.825-1.175T2 10q0-1.65 1.175-2.825T6 6q.95 0 1.8.4t1.45 1.1q.8-1 2-1.5T15 5q2.5 0 4.25 1.75T21 11q0 1.25-.487 2.35T18.9 15H6Z"/><path d="M12 15l4-6h-3l1-4l-4 6h3z" fill="currentColor"/></symbol>
  <symbol id="i-snow" viewBox="0 0 24 24"><path fill="currentColor" d="M6 14q-1.65 0-2.825-1.175T2 10q0-1.65 1.175-2.825T6 6q.95 0 1.8.4t1.45 1.1q.8-1 2-1.5T15 5q2.5 0 4.25 1.75T21 11q0 1.25-.487 2.35T18.9 15H6Z"/><path d="M12 18v-6m0 0l2.5 1.5M12 12l-2.5 1.5M12 18l2.5 1.5M12 18l-2.5 1.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></symbol>
  <symbol id="i-mist" viewBox="0 0 24 24"><path fill="currentColor" d="M3 9h18v1H3zm2 3h14v1H5zm-1 3h16v1H4z"/></symbol>
  <symbol id="i-wind" viewBox="0 0 24 24"><path fill="currentColor" d="M3 10h10a2 2 0 1 0-2-2h-1a3 3 0 1 1 3 3H3zm0 4h15a2 2 0 1 1-2 2h-1a3 3 0 1 0 3-3H3z"/></symbol>
  <symbol id="i-partly" viewBox="0 0 24 24"><path fill="currentColor" d="M8 18q-1.65 0-2.825-1.175T4 14q0-1.65 1.175-2.825T8 10q.95 0 1.8.4t1.45 1.1q.8-1 2-1.5T17 9q1.85 0 3.175 1.325T21.5 13q0 1.45-.9 2.575T18.4 17H8Z"/><path d="M6 5l1 2l2 1l-2 1l-1 2l-1-2L3 8l2-1z" fill="currentColor"/></symbol>
</svg>

<script>
(() => {
  const $ = s => document.querySelector(s);

  /* ===== ÁLLAPOT ===== */
  const state = {
    units:'metric', theme:'auto',
    place:null, data:null,
    map:{ z:6, x:19.0408, y:47.4979, dragging:false, last:null }, // Budapest default
    radar:{ frames:[], idx:0, playing:true, timer:null },
    deferredPrompt:null
  };

  /* ===== TÉMA ===== */
  const applyTheme = () => {
    const root = document.documentElement;
    root.removeAttribute('data-force');
    if(state.theme==='light') root.setAttribute('data-force','light');
    if(state.theme==='dark') root.setAttribute('data-force','dark');
    localStorage.setItem('weather:theme', state.theme);
    $('#themeAuto').classList.toggle('active', state.theme==='auto');
    $('#themeLight').classList.toggle('active', state.theme==='light');
    $('#themeDark').classList.toggle('active', state.theme==='dark');
  };
  const savedTheme = localStorage.getItem('weather:theme');
  if(savedTheme) state.theme = savedTheme;
  applyTheme();
  $('#themeAuto').onclick = ()=>{ state.theme='auto'; applyTheme(); };
  $('#themeLight').onclick = ()=>{ state.theme='light'; applyTheme(); };
  $('#themeDark').onclick = ()=>{ state.theme='dark'; applyTheme(); };

  /* ===== MÉRTÉKEGYSÉG ===== */
  $('#unitC').onclick = ()=> setUnits('metric');
  $('#unitF').onclick = ()=> setUnits('imperial');
  function setUnits(u, silent=false){
    state.units=u;
    $('#unitC').classList.toggle('active', u==='metric');
    $('#unitF').classList.toggle('active', u==='imperial');
    if(!silent && state.place) fetchAll();
    persist();
  }

  /* ===== KERESŐ / GEO ===== */
  $('#searchBtn').onclick = onSearch;
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') onSearch(); });
  $('#geoBtn').onclick = useGeolocation;

  const saved = localStorage.getItem('weather:last');
  if(saved){
    try{ const last = JSON.parse(saved); if(last.units) setUnits(last.units,true); if(last.place){ state.place=last.place; fetchAll(); mapCenter(last.place.lat,last.place.lon,7);} }
    catch{}
  }else{
    useGeolocation(); // ha nem engedélyezett, marad a default BP és kézi keresés
  }

  async function onSearch(){
    const term = $('#q').value.trim();
    if(!term) return shake($('#q'));
    try{
      const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(term)}&count=1&language=hu&format=json`);
      if(!res.ok) throw new Error('geocoding');
      const geo = await res.json();
      if(!geo.results?.length) return toast('Nem található ilyen város.', 'warn');
      const r = geo.results[0];
      state.place = { name:r.name, country:r.country_code||r.country, admin1:r.admin1||'', lat:r.latitude, lon:r.longitude, timezone:r.timezone };
      persist();
      await fetchAll();
      mapCenter(state.place.lat, state.place.lon, 8);
    }catch(e){ console.error(e); toast('Keresés közben hiba történt.', 'err'); }
  }

  function useGeolocation(){
    if(!navigator.geolocation){ toast('A böngésző nem támogatja a helymeghatározást.', 'warn'); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      const {latitude:lat, longitude:lon} = pos.coords;
      try{
        const r = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=hu&format=json`).then(r=>r.json());
        const g = r?.results?.[0] || {};
        state.place = { name:g.name||'Jelenlegi hely', country:g.country_code||g.country||'', admin1:g.admin1||'', lat, lon, timezone:g.timezone||'auto' };
      }catch{
        state.place = { name:'Jelenlegi hely', country:'', admin1:'', lat, lon, timezone:'auto' };
      }
      persist();
      fetchAll();
      mapCenter(lat, lon, 8);
    }, err=>{ console.warn(err); toast('Nem sikerült lekérni a helyzeted.', 'warn'); }, { enableHighAccuracy:false, timeout:10000, maximumAge:60000 });
  }

  /* ===== OPEN-METEO ===== */
  async function fetchAll(){
    if(!state.place){ toast('Nincs hely kiválasztva.', 'warn'); return; }
    skeleton(true);
    const {lat, lon, timezone} = state.place;
    const tempUnit = state.units==='metric'?'celsius':'fahrenheit';
    const windUnit = state.units==='metric'?'kmh':'mph';
    const precipUnit = state.units==='metric'?'mm':'inch';
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.search = new URLSearchParams({
      latitude: lat, longitude: lon,
      timeformat: 'iso8601',
      current: 'temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,surface_pressure,wind_speed_10m,wind_direction_10m',
      hourly: 'temperature_2m,apparent_temperature,relative_humidity_2m,precipitation_probability,weather_code,wind_speed_10m,wind_direction_10m',
      daily: 'weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum,precipitation_probability_max,wind_speed_10m_max',
      timezone: timezone||'auto', temperature_unit: tempUnit, wind_speed_unit: windUnit, precipitation_unit: precipUnit, forecast_days: 7
    }).toString();
    try{
      const res = await fetch(url);
      if(!res.ok) throw new Error('forecast');
      const data = await res.json();
      if(!data?.current || !data?.hourly || !data?.daily) throw new Error('invalid');
      state.data = data;
      renderAll();
      skeleton(false);
      toast('Frissítve.', 'ok', 1200);
    }catch(err){
      console.error(err);
      skeleton(false);
      toast('Nem sikerült lekérni az előrejelzést.', 'err');
    }
  }

  function renderAll(){
    const {place,data} = state; if(!place||!data) return;
    const tz = data.timezone || place.timezone || 'helyi idő';
    $('#place').textContent = [place.name, place.admin1, place.country].filter(Boolean).join(', ');
    $('#tz').textContent = tz.replace('_',' ');
    $('#updated').textContent = 'Most frissítve';

    const c = data.current, d0 = data.daily, isDay = !!c.is_day;
    $('#currentIcon').innerHTML = svgUse(pickIcon(c.weather_code,isDay), 96);
    $('#temp').textContent = round(c.temperature_2m) + '°';
    $('#desc').textContent = describeWMO(c.weather_code);
    $('#feels').textContent = round(c.apparent_temperature) + '°';
    $('#humidity').textContent = c.relative_humidity_2m + '%';
    $('#wind').textContent = round(c.wind_speed_10m) + (state.units==='metric'?' km/h':' mph');
    $('#pressure').textContent = round(c.surface_pressure) + ' hPa';
    $('#sunrise').textContent = formatTime(d0.sunrise[0]);
    $('#sunset').textContent = formatTime(d0.sunset[0]);

    const H = data.hourly;
    const nowIdx = nearestIndex(H.time, data.current.time);
    const upto = Math.min(nowIdx+24, H.time.length);
    const tiles = [];
    for(let i=nowIdx;i<upto;i++){
      const t = H.time[i];
      tiles.push(tileHour({
        time:t, temp:round(H.temperature_2m[i]),
        pop: H.precipitation_probability?.[i] ?? null,
        wcode:H.weather_code[i],
        isDay: guessIsDay(t, d0.sunrise[0], d0.sunset[0]),
        wind: round(H.wind_speed_10m[i])
      }));
    }
    $('#hourly').innerHTML = tiles.join('');
    $('#hourlyRange').textContent = formatTime(H.time[nowIdx])+' – '+formatTime(H.time[upto-1]);

    const rows = [];
    for(let i=0;i<d0.time.length;i++){
      rows.push(rowDay({
        date:d0.time[i], wcode:d0.weather_code[i], tmin:round(d0.temperature_2m_min[i]),
        tmax:round(d0.temperature_2m_max[i]), pop:d0.precipitation_probability_max?.[i] ?? null,
        psum:d0.precipitation_sum?.[i] ?? null, wind:round(d0.wind_speed_10m_max?.[i] ?? 0)
      }));
    }
    $('#daily').innerHTML = rows.join('');
    $('#dailyRange').textContent = niceDate(d0.time[0])+' – '+niceDate(d0.time[d0.time.length-1]);
  }

  /* ===== UI segédek ===== */
  function skeleton(active){
    $('#temp').textContent = active ? '—°' : $('#temp').textContent;
    $('#updated').textContent = active ? 'Frissítés…' : 'Most frissítve';
    if(active){
      $('#hourly').innerHTML = Array.from({length:6}).map(()=>`<div class="tile"><div class="skeleton" style="width:60px;height:60px;border-radius:14px"></div><div class="skeleton" style="width:70px"></div><div class="skeleton" style="width:40px"></div></div>`).join('');
      $('#daily').innerHTML = Array.from({length:5}).map(()=>`<div class="dayrow"><div class="skeleton" style="width:120px"></div><div class="skeleton" style="width:50px"></div><div class="skeleton" style="width:70px"></div><div class="skeleton" style="width:60px"></div></div>`).join('');
    }
  }
  function toast(msg, kind='ok', ms=1800){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position='fixed'; el.style.left='50%'; el.style.bottom='22px'; el.style.transform='translateX(-50%)';
    el.style.background= kind==='ok'? '#10b981' : kind==='warn'? '#f59e0b' : '#ef4444';
    el.style.color='#001018'; el.style.padding='10px 14px'; el.style.borderRadius='999px'; el.style.boxShadow:'0 10px 30px rgba(0,0,0,.35)'; el.style.fontWeight='700';
    el.style.zIndex=9999; el.style.opacity='0'; el.style.transition='opacity .2s ease';
    document.body.appendChild(el); requestAnimationFrame(()=> el.style.opacity='1');
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),200); }, ms);
  }
  function shake(input){
    const el = input.closest('.search');
    el.style.transform='translateX(0)';
    el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:260});
    input.focus();
  }
  function svgUse(id,size=48){ return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" aria-hidden="true"><use href="#${id}"/></svg>`; }
  const round = x => Math.round(Number(x));
  const pad = n => n<10 ? '0'+n : n;
  const formatTime = s => { const d=new Date(s); return pad(d.getHours())+':'+pad(d.getMinutes()); };
  const niceDate = s => { const d=new Date(s); return d.toLocaleDateString('hu-HU',{month:'short',day:'2-digit',weekday:'short'}); };
  const nearestIndex = (arr,iso)=>{ const now=new Date(iso).getTime(); const i=arr.findIndex(t=>new Date(t).getTime()>=now); return i<0?0:i; };
  const guessIsDay = (iso,sr,ss)=>{ const t=+new Date(iso); return t>=+new Date(sr) && t<+new Date(ss); };
  function tileHour({time,temp,pop,wcode,isDay,wind}){
    const label = new Date(time).toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'});
    return `<div class="tile" title="${label}">${svgUse(pickIcon(wcode,isDay),42)}<div><strong>${temp}°</strong></div><div class="muted small">${label}</div><div class="muted small">${pop!=null?`Csap.: ${pop}%`:'&nbsp;'}</div><div class="muted small">Szél: ${wind} ${state.units==='metric'?'km/h':'mph'}</div></div>`;
  }
  function rowDay({date,wcode,tmin,tmax,pop,psum,wind}){
    const name=new Date(date).toLocaleDateString('hu-HU',{weekday:'long'});
    return `<div class="dayrow"><div class="row" style="gap:12px">${svgUse(pickIcon(wcode,true),28)}<div><strong>${name}</strong><div class="muted small">${new Date(date).toLocaleDateString('hu-HU',{month:'long',day:'2-digit'})}</div></div></div><div class="muted small">${pop!=null?`Csap.: ${pop}%`:'—'}</div><div class="row"><strong>${tmax}°</strong> <span class="muted">/</span> <span class="muted">${tmin}°</span></div><div class="muted small">Szél: ${wind} ${state.units==='metric'?'km/h':'mph'}</div></div>`;
  }
  function pickIcon(code,isDay){
    if(code===0) return isDay?'i-clear-day':'i-clear-night';
    if(code===1||code===2) return 'i-partly';
    if(code===3) return 'i-cloud';
    if([45,48].includes(code)) return 'i-mist';
    if([51,53,55,56,57,61,63,65].includes(code)) return 'i-rain';
    if([66,67,80,81,82].includes(code)) return 'i-shower';
    if([71,73,75,77,85,86].includes(code)) return 'i-snow';
    if([95,96,99].includes(code)) return 'i-thunder';
    return 'i-wind';
  }
  function persist(){ localStorage.setItem('weather:last', JSON.stringify({ units:state.units, place:state.place })); }

  /* ===== TÉRKÉP (slippy) ===== */
  const map = $('#map'), baseLayer = $('#baseLayer'), radarLayer = $('#radarLayer'), dotsEl = $('#dots'), timeLabel = $('#timeLabel');
  const osm = (z,x,y)=>`https://tile.openstreetmap.org/${z}/${x}/${y}.png`;
  const lon2x = (lon,z)=> ((lon+180)/360)*Math.pow(2,z);
  const lat2y = (lat,z)=>{ const r=lat*Math.PI/180, n=Math.pow(2,z); return (1-Math.log(Math.tan(r)+1/Math.cos(r))/Math.PI)/2*n; };
  const x2lon = (x,z)=> x/Math.pow(2,z)*360-180;
  const y2lat = (y,z)=>{ const n=Math.PI-2*Math.PI*y/Math.pow(2,z); return 180/Math.PI*Math.atan(0.5*(Math.exp(n)-Math.exp(-n))); };

  function mapCenter(lat,lon,z=7){ state.map.z=z; state.map.x=lon; state.map.y=lat; renderMap(); }
  function renderMap(){
    const { z } = state.map;
    const w = map.clientWidth, h = map.clientHeight;
    const centerX = lon2x(state.map.x,z), centerY = lat2y(state.map.y,z);
    const tileSize=256;
    const tilesX = Math.ceil(w/tileSize)+2;
    const tilesY = Math.ceil(h/tileSize)+2;
    const startX = Math.floor(centerX-tilesX/2);
    const startY = Math.floor(centerY-tilesY/2);
    const offsetX = (startX-centerX)*tileSize + w/2;
    const offsetY = (startY-centerY)*tileSize + h/2;

    function drawLayer(container, urlFn){
      container.innerHTML='';
      for(let i=0;i<tilesX;i++){
        for(let j=0;j<tilesY;j++){
          let x = startX+i, y = startY+j;
          const max = Math.pow(2,z);
          let wrappedX = ((x%max)+max)%max;
          if(y<0||y>=max) continue;
          const img = new Image(256,256);
          img.className='tile';
          img.style.left = Math.round(offsetX + i*tileSize) + 'px';
          img.style.top  = Math.round(offsetY + j*tileSize) + 'px';
          img.loading='lazy'; img.decoding='async'; img.referrerPolicy='no-referrer';
          img.src = urlFn(z, wrappedX, y);
          container.appendChild(img);
        }
      }
    }
    drawLayer(baseLayer, osm);
    drawRadar(); // aktuális frame
  }
  $('#zoomIn').onclick = ()=>{ state.map.z = Math.min(12, state.map.z+1); renderMap(); };
  $('#zoomOut').onclick = ()=>{ state.map.z = Math.max(2, state.map.z-1); renderMap(); };
  $('#locate').onclick = ()=>{ if(state.place) mapCenter(state.place.lat, state.place.lon, Math.max(8,state.map.z)); };
  map.addEventListener('pointerdown', e=>{ state.map.dragging=true; state.map.last={x:e.clientX,y:e.clientY}; map.setPointerCapture(e.pointerId); });
  map.addEventListener('pointermove', e=>{
    if(!state.map.dragging) return;
    const dx=e.clientX-state.map.last.x, dy=e.clientY-state.map.last.y;
    state.map.last={x:e.clientX,y:e.clientY};
    const worldW = 256*Math.pow(2,state.map.z);
    const lonPerPx = 360/worldW, latPerPx = 360/worldW;
    state.map.x -= dx*lonPerPx;
    state.map.y += dy*latPerPx;
    renderMap();
  });
  map.addEventListener('pointerup', ()=>{ state.map.dragging=false; });
  map.addEventListener('wheel', e=>{ e.preventDefault(); const d=Math.sign(e.deltaY); state.map.z=Math.min(12,Math.max(2,state.map.z-d)); renderMap(); }, {passive:false});

  /* ===== RAINVIEWER ===== */
  const radar = state.radar;
  async function loadFrames(){
    try{
      const j = await fetch('https://api.rainviewer.com/public/weather-maps.json').then(r=>r.json());
      radar.frames = (j?.radar?.past||[]).concat(j?.radar?.nowcast||[]);
      if(!radar.frames.length) throw new Error('no-frames');
      radar.idx = radar.frames.length-1;
      buildTimeline(); drawRadar(); play();
    }catch(e){ console.error(e); toast('Nem sikerült betölteni a radart.', 'warn'); }
  }
  function radarTileURL(ts,z,x,y){ return `https://tilecache.rainviewer.com/v2/radar/${ts}/256/${z}/${x}/${y}/2/1_1.png`; }
  function drawRadar(){
    if(!radar.frames.length) return;
    const fr = radar.frames[radar.idx];
    const { z } = state.map;
    const w = map.clientWidth, h = map.clientHeight;
    const centerX = lon2x(state.map.x,z), centerY = lat2y(state.map.y,z);
    const tileSize=256;
    const tilesX = Math.ceil(w/tileSize)+2;
    const tilesY = Math.ceil(h/tileSize)+2;
    const startX = Math.floor(centerX-tilesX/2);
    const startY = Math.floor(centerY-tilesY/2);
    const offsetX = (startX-centerX)*tileSize + w/2;
    const offsetY = (startY-centerY)*tileSize + h/2;

    radarLayer.innerHTML='';
    for(let i=0;i<tilesX;i++){
      for(let j=0;j<tilesY;j++){
        let x=startX+i, y=startY+j;
        const max=Math.pow(2,z);
        let wrappedX=((x%max)+max)%max;
        if(y<0||y>=max) continue;
        const img=new Image(256,256);
        img.className='tile';
        img.style.left = Math.round(offsetX + i*tileSize) + 'px';
        img.style.top  = Math.round(offsetY + j*tileSize) + 'px';
        img.loading='lazy'; img.decoding='async'; img.referrerPolicy='no-referrer';
        img.src = radarTileURL(fr.time, z, wrappedX, y);
        radarLayer.appendChild(img);
      }
    }
    const dt = new Date(fr.time*1000);
    timeLabel.textContent = dt.toLocaleString('hu-HU',{hour:'2-digit',minute:'2-digit',month:'short',day:'2-digit'});
    highlightDot();
  }
  function buildTimeline(){
    dotsEl.innerHTML='';
    radar.frames.forEach((_,i)=>{
      const d=document.createElement('div');
      d.className='dot'+(i===radar.idx?' active':'');
      d.title=new Date(radar.frames[i].time*1000).toLocaleString('hu-HU');
      d.onclick=()=>{ radar.idx=i; drawRadar(); pause(); };
      dotsEl.appendChild(d);
    });
  }
  function highlightDot(){ [...dotsEl.children].forEach((el,i)=>el.classList.toggle('active', i===radar.idx)); }
  function step(dir=1){ if(!radar.frames.length) return; radar.idx=(radar.idx+dir+radar.frames.length)%radar.frames.length; drawRadar(); }
  function play(){ pause(); radar.playing=true; radar.timer=setInterval(()=>step(1), 800); }
  function pause(){ radar.playing=false; if(radar.timer){ clearInterval(radar.timer); radar.timer=null; } }
  $('#radarPlay').onclick = play; $('#radarPause').onclick = pause; $('#radarNow').onclick = ()=>{ radar.idx=Math.max(0,radar.frames.length-1); drawRadar(); };
  loadFrames();

  /* ===== PWA ===== */
  const manifest = {
    name:"Időjárás + Esőradar", short_name:"Időjárás", start_url:".", display:"standalone",
    background_color:"#0f172a", theme_color:"#0f172a",
    icons:[{ src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='28' fill='%2322d3ee'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-size='72'%3E%E2%98%81%3C/text%3E%3Ctext x='62%25' y='76%25' dominant-baseline='middle' text-anchor='middle' font-size='38'%3E%E2%98%94%3C/text%3E%3C/svg%3E", sizes:"128x128", type:"image/svg+xml", purpose:"any maskable" }]
  };
  const manifestURL = "data:application/manifest+json," + encodeURIComponent(JSON.stringify(manifest));
  document.getElementById('manifest-link').setAttribute('href', manifestURL);

  const swCode = `
    const CACHE='wx-shell-v1'; const CORE=['.'];
    self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE))); self.skipWaiting(); });
    self.addEventListener('activate',e=>{ e.waitUntil((async()=>{ const keys=await caches.keys(); await Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))); self.clients.claim(); })()); });
    self.addEventListener('fetch',e=>{
      const url=new URL(e.request.url);
      if(url.origin===location.origin){
        e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(resp=>{ const copy=resp.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return resp; })));
      }
    });
  `;
  if(location.protocol.startsWith('http') && 'serviceWorker' in navigator){
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); state.deferredPrompt=e; $('#installBtn').classList.remove('hidden');
  });
  $('#installBtn').onclick = async ()=>{
    if(!state.deferredPrompt) return;
    state.deferredPrompt.prompt(); const { outcome } = await state.deferredPrompt.userChoice;
    if(outcome==='accepted') $('#installBtn').classList.add('hidden'); state.deferredPrompt=null;
  };

})();
</script>
</body>
</html>
