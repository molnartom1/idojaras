<!DOCTYPE html>
<html lang="hu" data-theme="auto">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Időjárás – Egyfájlos PWA • Offline • Animált ikonok • Radar</title>
<meta name="theme-color" content="#0f172a" />
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0f172a; --card:#111827cc; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
    --ok:#34d399; --warn:#f59e0b; --danger:#f87171; --ring:#22d3ee55; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f1f5f9; --card:#ffffffea; --muted:#475569; --text:#0f172a; --accent:#0891b2;
      --ok:#059669; --warn:#d97706; --danger:#ef4444; --ring:#06b6d455;
    }
    :root[data-force="dark"]{ --bg:#0f172a; --card:#111827cc; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b; --danger:#f87171; --ring:#22d3ee55; }
  }
  :root[data-force="light"]{ --bg:#f1f5f9; --card:#ffffffea; --muted:#475569; --text:#0f172a; --accent:#0891B2; --ok:#059669; --warn:#d97706; --danger:#ef4444; --ring:#06b6d455; }
  :root[data-force="dark"]{ --bg:#0f172a; --card:#111827cc; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b; --danger:#f87171; --ring:#22d3ee55; }

  *{box-sizing:border-box}
  html,body{height:100%}
  html, body { overflow-x: hidden; }
  body{
    margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";
    background: radial-gradient(1200px 800px at 10% -10%, #22d3ee22, transparent 70%), radial-gradient(1000px 700px at 110% -10%, #a78bfa22, transparent 70%), var(--bg);
    color:var(--text); display:flex; justify-content:center; padding:clamp(12px,3vw,28px);
  }

  .app{ width:100%; max-width:1100px; display:grid; gap:14px; }
  .app, .grid, .card { min-width:0; }

  header{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{ width:38px; height:38px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#a78bfa); display:grid; place-items:center; color:#001018; font-weight:800; box-shadow:var(--shadow) }
  h1{ margin:0; font-size:clamp(1.1rem,3.3vw,1.6rem) }
  .muted{ color:var(--muted) } .small{ font-size:.92rem }

  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; width:100%; align-items:center; position:relative; }
  .search{ position:relative; flex:1 1 260px; display:flex; gap:8px; align-items:center; background:var(--card); padding:8px; border-radius:14px; box-shadow:var(--shadow); border:1px solid transparent; }
  .search:focus-within{ outline:2px solid var(--ring); border-color:transparent }
  .search input{ flex:1; border:0; background:transparent; color:var(--text); font-size:16px; padding:10px; outline:none; }
  .btn{ border:0; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.2s transform ease,.2s background ease,.2s opacity ease; background:var(--accent); color:#001018; box-shadow:var(--shadow) }
  .btn:hover{ transform:translateY(-1px) }
  .btn.secondary{ background:#334155; color:#e5e7eb } @media (prefers-color-scheme: light){ .btn.secondary{ background:#e2e8f0; color:#0f172a } }
  .install{ background:#10b981; color:#001018; display:none } .install.show{ display:inline-block }

  /* Autocomplete */
  .ac{ position:absolute; left:8px; right:8px; top:100%; margin-top:6px; background:var(--card); border:1px solid #ffffff22; border-radius:12px; box-shadow:var(--shadow); overflow:hidden; z-index:50; display:none; }
  .ac.show{ display:block; }
  .ac-item{ padding:10px 12px; display:flex; justify-content:space-between; gap:12px; cursor:pointer; }
  .ac-item:hover{ background:#ffffff10; }
  .ac-name{ font-weight:700 }
  .ac-sub{ color:var(--muted); font-size:.92rem }

  .offline-badge{ display:none; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:#f59e0b; color:#001018; font-weight:700 }
  .offline-badge.show{ display:inline-flex }

  .grid{ display:grid; gap:14px; grid-template-columns:1fr }
  @media (min-width:820px){ .grid{ grid-template-columns:1.1fr .9fr } }

  .card{ background:var(--card); border:1px solid #ffffff10; border-radius:var(--radius); box-shadow:var(--shadow); padding:14px }
  .current{ display:grid; grid-template-columns:auto 1fr; gap:12px; align-items:center }
  .bigtemp{ font-size:clamp(2.6rem,7vw,4.3rem); font-weight:800; letter-spacing:-1px }
  .desc{ font-size:1rem; text-transform:capitalize }
  .meta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }
  .chip{ background:#ffffff10; padding:8px 10px; border-radius:999px; font-size:.92rem; display:flex; gap:8px; align-items:center }

  .scroll{ display:flex; gap:10px; overflow-x:auto; overflow-y:hidden; padding-bottom:6px; scroll-snap-type:x mandatory; width:100%; max-width:100%; -webkit-overflow-scrolling:touch }
  .tile{ flex:0 0 auto; min-width:clamp(86px, 28vw, 120px); scroll-snap-align:start; background:#ffffff10; border:1px solid #ffffff14; border-radius:14px; padding:10px; display:grid; gap:6px; place-items:center }

  .daygrid{ display:grid; gap:10px }
  .dayrow{ display:grid; grid-template-columns:1fr auto auto auto; gap:10px; align-items:center; padding:10px 12px; border-radius:12px; background:#ffffff10; border:1px solid #ffffff14 }

  .unit-toggle,.theme-toggle{ background:#ffffff10; border:1px solid #ffffff14; border-radius:12px; padding:4px; display:flex; gap:4px; align-items:center }
  .seg{ padding:6px 10px; border-radius:8px; cursor:pointer; user-select:none }
  .seg.active{ background:var(--accent); color:#001018; font-weight:700 }
  .badge{ font-size:.8rem; padding:.2rem .5rem; border-radius:999px; background:#ffffff10; border:1px solid #ffffff22 }

  /* ANIMÁCIÓK – ikonokhoz */
  @keyframes spin-slow { from{transform:rotate(0)} to{transform:rotate(360deg)} }
  @keyframes float-x   { 0%{transform:translateX(0)} 50%{transform:translateX(6px)} 100%{transform:translateX(0)} }
  @keyframes fall      { 0%{transform:translateY(-6px); opacity:0} 30%{opacity:1} 100%{transform:translateY(8px); opacity:0} }
  @keyframes blink     { 0%,80%{opacity:0.2} 85%{opacity:1} 100%{opacity:0.2} }
  @keyframes drift     { 0%{transform:translateX(0)} 100%{transform:translateX(12px)} }

  .ico-sun .rays{ transform-origin:50% 50%; animation:spin-slow 16s linear infinite }
  .ico-cloud .cloud{ animation:float-x 6s ease-in-out infinite }
  .ico-rain .drop{ animation:fall 1.2s ease-in infinite; }
  .ico-snow .flake{ animation:fall 1.8s linear infinite }
  .ico-thunder .bolt{ animation:blink 1.8s ease-in-out infinite }
  .ico-mist .band{ animation:drift 8s linear infinite; animation-direction:alternate }

  /* színezés */
  .wc-sun{ color:#fbbf24 } .wc-night{ color:#93c5fd } .wc-partly{ color:#fde68a }
  .wc-cloud{ color:#9ca3af } .wc-mist{ color:#94a3b8 } .wc-rain{ color:#60a5fa }
  .wc-shower{ color:#38bdf8 } .wc-snow{ color:#e5e7eb } .wc-thunder{ color:#f59e0b } .wc-wind{ color:#a78bfa }
  @media (prefers-color-scheme: light){ .wc-cloud{ color:#64748b } .wc-mist{ color:#64748b } .wc-snow{ color:#2563eb } }

  /* RADAR – CANVAS */
  .map-card{ padding:0; overflow:hidden }
  .map-toolbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px 12px 0 12px }
  .map{ position:relative; height:420px; background:#0b1220; touch-action:pinch-zoom pan-x pan-y; user-select:none; overflow:hidden; border-radius:0 0 var(--radius) var(--radius) }
  canvas.mapc{ position:absolute; inset:0; width:100%; height:100%; display:block; }
  .map-controls{ position:absolute; right:10px; top:10px; display:grid; gap:6px; z-index:10 }
  .ctrl{ background:#ffffff18; border:1px solid #ffffff30; backdrop-filter:blur(6px); padding:8px; border-radius:10px; cursor:pointer; font-weight:800 }
  .timeline{ position:absolute; left:50%; bottom:12px; transform:translateX(-50%); display:flex; gap:6px; align-items:center; background:#00000040; border:1px solid #ffffff30; padding:6px 10px; border-radius:999px; backdrop-filter:blur(6px) }
  .dot{ width:8px; height:8px; border-radius:999px; background:#ffffff55 }
  .dot.active{ background:var(--accent) }
  .time-label{ color:#fff; font-size:.9rem; margin-left:6px }
</style>
</head>
<body>
<div class="app" id="app" data-units="metric">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">⛅</div>
      <div>
        <h1>Időjárás előrejelzés</h1>
        <div class="muted small">Egyfájlos PWA • Offline mód • Animált ikonok • Radar</div>
      </div>
    </div>
    <div class="row" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
      <span id="offlineBadge" class="offline-badge" title="Cache-ből megjelenített adatok">⚠ Offline mód</span>
      <div class="theme-toggle" role="tablist" aria-label="Téma">
        <button class="seg" id="themeAuto" role="tab">Auto</button>
        <button class="seg" id="themeLight" role="tab">Világos</button>
        <button class="seg" id="themeDark" role="tab">Sötét</button>
      </div>
      <div class="unit-toggle" role="tablist" aria-label="Mértékegység">
        <button class="seg active" id="unitC" role="tab" aria-selected="true">°C</button>
        <button class="seg" id="unitF" role="tab" aria-selected="false">°F</button>
      </div>
      <button id="installBtn" class="btn install" type="button" title="Telepítés">Telepítés</button>
    </div>
  </header>

  <div class="toolbar">
    <label class="search" for="q">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21 20.3 17.2 16.5a8 8 0 1 0-1 1L20.3 21zM5 11a6 6 0 1 1 12 0A6 6 0 0 1 5 11"/></svg>
      <input id="q" type="search" placeholder="Város/település keresése (pl. Budapest, Pécs, Debrecen)" autocomplete="off" />
      <button class="btn" id="searchBtn" type="button">Keresés</button>
      <div class="ac" id="ac"></div>
    </label>
    <button class="btn secondary" id="geoBtn" type="button" title="Saját helyzetem">Saját helyzetem</button>
  </div>

  <section class="grid" id="content">
    <article class="card">
      <div class="current" id="current">
        <div id="currentIcon" aria-hidden="true"></div>
        <div>
          <div class="locline" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap">
            <strong id="place">—</strong>
            <span class="badge" id="tz">—</span>
            <span class="badge" id="updated">Frissítés…</span>
          </div>
          <div class="bigtemp" id="temp">—°</div>
          <div class="desc" id="desc">—</div>
          <div class="meta" id="meta">
            <div class="chip"><span class="ico">🌡</span><span>Hőérzet: <b id="feels">—</b></span></div>
            <div class="chip"><span class="ico">💧</span><span>Páratartalom: <b id="humidity">—</b></span></div>
            <div class="chip"><span class="ico">🌬</span><span>Szél: <b id="wind">—</b></span></div>
            <div class="chip"><span class="ico">📈</span><span>Nyomás: <b id="pressure">—</b></span></div>
            <div class="chip"><span class="ico">🌅</span><span>Napkelte: <b id="sunrise">—</b></span></div>
            <div class="chip"><span class="ico">🌇</span><span>Napnyugta: <b id="sunset">—</b></span></div>
          </div>
        </div>
      </div>
    </article>

    <article class="card">
      <div class="row" style="display:flex; justify-content:space-between; margin-bottom:8px">
        <h3 style="margin:0">Következő órák</h3>
        <span class="muted small" id="hourlyRange">—</span>
      </div>
      <div class="scroll" id="hourly"><div class="muted small" style="padding:8px">Betöltés…</div></div>
    </article>

    <article class="card" style="grid-column:1/-1">
      <div class="row" style="display:flex; justify-content:space-between; margin-bottom:8px">
        <h3 style="margin:0">7 napos előrejelzés</h3>
        <span class="muted small" id="dailyRange">—</span>
      </div>
      <div class="daygrid" id="daily"><div class="muted small" style="padding:8px">Betöltés…</div></div>
    </article>

    <!-- RADAR (CANVAS) -->
    <article class="card map-card" style="grid-column:1/-1">
      <div class="map-toolbar">
        <h3 style="margin:0">Esőradar (RainViewer + OSM)</h3>
        <div class="row" style="display:flex; gap:8px">
          <button class="btn secondary" id="radarPlay">Lejátszás</button>
          <button class="btn secondary" id="radarPause">Szünet</button>
          <button class="btn secondary" id="radarNow">Most</button>
        </div>
      </div>
      <div class="map" id="map">
        <canvas id="baseCanvas" class="mapc"></canvas>
        <canvas id="radarCanvas" class="mapc" style="opacity:.78"></canvas>
        <div class="map-controls">
          <button class="ctrl" id="zoomIn" aria-label="Nagyítás">＋</button>
          <button class="ctrl" id="zoomOut" aria-label="Kicsinyítés">－</button>
          <button class="ctrl" id="locate" aria-label="Ugrás a helyzetemre">📍</button>
        </div>
        <div class="timeline" id="timeline">
          <div class="row" id="dots" style="display:flex; gap:6px"></div>
          <div class="time-label" id="timeLabel">—</div>
        </div>
      </div>
    </article>
  </section>

  <footer>
    Adatok: Open-Meteo • Radar: RainViewer • Térkép: OpenStreetMap
  </footer>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const OFFLINE_BADGE = $('#offlineBadge');

  /* ========= 0) BEÁGYAZOTT MANIFEST + SW LÉTREHOZÁS ========= */
  // — ikonok (placeholder data: 1×1 PNG) — bármikor cserélhetőek igazi PNG-re
  const PNG1x1 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMB/axhXlEAAAAASUVORK5CYII=";

  const manifestObj = {
    name: "Időjárás – Előrejelzés + Esőradar",
    short_name: "Időjárás",
    start_url: "./",
    scope: "./",
    display: "standalone",
    background_color: "#0f172a",
    theme_color: "#0f172a",
    lang: "hu",
    icons: [
      { src: PNG1x1, sizes: "192x192", type: "image/png", purpose: "any maskable" },
      { src: PNG1x1, sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ]
  };
  const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifestObj)], {type:"application/manifest+json"}));
  // a manifestet head-hez adjuk
  const ml = document.createElement('link'); ml.rel='manifest'; ml.href=manifestURL; document.head.appendChild(ml);

  // — service worker kód (network-first API + shell cache + tile SWR)
  const SW_CODE = `
    const CACHE_STATIC = 'wx-static-v1.2';
    const CACHE_RUNTIME = 'wx-runtime-v1.2';
    const CACHE_API = 'wx-api-v1.2';

    const CORE_ASSETS = [
      './' // egyfájlos app – maga az oldal
    ];

    self.addEventListener('install', (e)=>{
      e.waitUntil(
        caches.open(CACHE_STATIC).then(c=>c.addAll(CORE_ASSETS)).then(()=>self.skipWaiting())
      );
    });

    self.addEventListener('activate', (e)=>{
      e.waitUntil(
        caches.keys().then(keys=>Promise.all(
          keys.filter(k=>![CACHE_STATIC, CACHE_RUNTIME, CACHE_API].includes(k)).map(k=>caches.delete(k))
        )).then(()=>self.clients.claim())
      );
    });

    self.addEventListener('fetch', (e)=>{
      const req = e.request;
      const url = new URL(req.url);

      // App shell – cache-first
      if (url.origin === self.location.origin && (url.pathname==='/' || url.pathname.endsWith('.html') || url.pathname==='')){
        e.respondWith(caches.match(req).then(hit=> hit || fetch(req)));
        return;
      }

      // Csempék (OSM/RainViewer): stale-while-revalidate
      if (/tile\\.openstreetmap\\.org|tilecache\\.rainviewer\\.com/.test(url.hostname)){
        e.respondWith((async ()=>{
          const cache = await caches.open(CACHE_RUNTIME);
          const cached = await cache.match(req);
          const fetchPromise = fetch(req, {mode:'no-cors'}).then(res=>{
            try { cache.put(req, res.clone()); } catch(_){}
            return res;
          }).catch(_=> cached);
          return cached || fetchPromise;
        })());
        return;
      }

      // Open-Meteo – network-first + cache-fallback
      if (/api\\.open-meteo\\.com\\/v1\\/forecast/.test(req.url)){
        e.respondWith((async ()=>{
          const cache = await caches.open(CACHE_API);
          try{
            const fresh = await fetch(req);
            cache.put(req, fresh.clone());
            return fresh;
          }catch(_){
            const cached = await cache.match(req);
            return cached || Response.error();
          }
        })());
        return;
      }

      // Alap: network-first
      e.respondWith((async ()=>{
        try{ return await fetch(req); }
        catch(_){ const cached = await caches.match(req); return cached || Response.error(); }
      })());
    });
  `;
  const swURL = URL.createObjectURL(new Blob([SW_CODE], {type:'text/javascript'}));

  // SW reg + install prompt
  if('serviceWorker' in navigator){
    window.addEventListener('load', async ()=>{
      try{ await navigator.serviceWorker.register(swURL); }
      catch(e){ console.warn('SW reg hiba', e); }
    });
  }
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt = e;
    const btn = $('#installBtn'); btn.classList.add('show');
    btn.onclick = async ()=>{ btn.classList.remove('show'); if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; };
  });

  /* ========= 1) FETCH SEGÉDEK ========= */
  async function xfetch(url, opts){
    opts = opts || {};
    const base = Object.assign({mode:'cors', referrerPolicy:'no-referrer', credentials:'omit'}, opts);
    try{
      const res = await fetch(url, base);
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res;
    }catch(e){
      const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
      const res2 = await fetch(proxy, {mode:'cors', referrerPolicy:'no-referrer', credentials:'omit'});
      if(!res2.ok) throw new Error('Proxy HTTP '+res2.status);
      return res2;
    }
  }
  async function xfetchJSONStrong(url){
    const headers = {'Accept':'application/json'};
    try{
      const r = await fetch(url, {mode:'cors', referrerPolicy:'no-referrer', credentials:'omit', headers});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const ct = r.headers.get('content-type')||'';
      const body = ct.includes('application/json') ? await r.json() : JSON.parse(await r.text());
      return body;
    }catch(e1){
      try{
        const r2 = await fetch('https://cors.isomorphic-git.org/'+url, {mode:'cors', referrerPolicy:'no-referrer', credentials:'omit', headers});
        if(!r2.ok) throw new Error('HTTP '+r2.status);
        const ct2 = r2.headers.get('content-type')||'';
        const body2 = ct2.includes('application/json') ? await r2.json() : JSON.parse(await r2.text());
        return body2;
      }catch(e2){
        const u3 = 'https://api.allorigins.win/raw?url='+encodeURIComponent(url);
        const r3 = await fetch(u3, {mode:'cors', referrerPolicy:'no-referrer', credentials:'omit', headers});
        if(!r3.ok) throw new Error('HTTP '+r3.status);
        const ct3 = r3.headers.get('content-type')||'';
        const body3 = ct3.includes('application/json') ? await r3.json() : JSON.parse(await r3.text());
        return body3;
      }
    }
  }

  /* ========= 2) APP ÁLLAPOT ========= */
  const state = {
    units:'metric', theme:'auto',
    place:null, data:null, tz:'Europe/Budapest', offline:false,
    acResults:[],
    map:{ z:6, lon:19.0408, lat:47.4979, dragging:false, last:null },
    radar:{ frames:[], idx:0, playing:true, timer:null }
  };

  /* ========= 3) TÉMA ========= */
  function applyTheme(){
    const root=document.documentElement;
    root.removeAttribute('data-force');
    if(state.theme==='light') root.setAttribute('data-force','light');
    if(state.theme==='dark')  root.setAttribute('data-force','dark');
    localStorage.setItem('weather:theme', state.theme);
    $('#themeAuto').classList.toggle('active', state.theme==='auto');
    $('#themeLight').classList.toggle('active', state.theme==='light');
    $('#themeDark').classList.toggle('active', state.theme==='dark');
  }
  (function(){
    const savedTheme = localStorage.getItem('weather:theme'); if(savedTheme) state.theme = savedTheme; applyTheme();
    $('#themeAuto').onclick = ()=>{ state.theme='auto'; applyTheme(); };
    $('#themeLight').onclick = ()=>{ state.theme='light'; applyTheme(); };
    $('#themeDark').onclick  = ()=>{ state.theme='dark';  applyTheme(); };
  })();

  /* ========= 4) EGYSÉGEK ========= */
  $('#unitC').onclick = ()=> setUnits('metric');
  $('#unitF').onclick = ()=> setUnits('imperial');
  function setUnits(u, silent){
    state.units=u;
    $('#unitC').classList.toggle('active', u==='metric');
    $('#unitF').classList.toggle('active', u==='imperial');
    if(!silent && state.place) fetchAll();
    persist();
  }

  /* ========= 5) KERESÉS + GEO ========= */
  const q = $('#q'), ac = $('#ac');
  $('#searchBtn').onclick = onSearch;
  q.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); if(state.acResults.length){ pickPlace(0); } else { onSearch(); } }
    if(e.key==='Escape'){ ac.classList.remove('show'); }
  });
  q.addEventListener('input', debounce(onType, 220));
  q.addEventListener('focus', ()=>{ if(state.acResults.length) ac.classList.add('show'); });
  $('#geoBtn').onclick = useGeolocation;

  const saved = localStorage.getItem('weather:last');
  if(saved){
    try{
      const last = JSON.parse(saved);
      if(last.units) setUnits(last.units, true);
      if(last.place){ state.place = last.place; mapCenter(last.place.lat,last.place.lon,7); }
    }catch(_){}
  }
  // Offline előnézet cache-ből, ha van
  const cachedData = loadDataCache();
  if(cachedData && !state.data){
    state.data = cachedData.payload;
    state.tz = cachedData.payload.timezone || 'auto';
    state.offline = true;
    renderAll();
    showOffline(true);
  }
  // majd friss online lekérés
  if(state.place){ fetchAll(); } else { useGeolocation(); setTimeout(fallbackIfNoPlace, 2500); }

  function fallbackIfNoPlace(){
    if(!state.place){
      state.place = { name:'Budapest', country:'HU', admin1:'Budapest',
        lat:47.4979, lon:19.0402, timezone:'Europe/Budapest' };
      persist(); fetchAll(); mapCenter(state.place.lat, state.place.lon, 8);
    }
  }

  async function onType(){
    const term = q.value.trim();
    if(term.length<2){ ac.classList.remove('show'); return; }
    try{
      const geo = await xfetchJSONStrong('https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(term)+'&count=5&language=hu&format=json');
      const list = (geo && geo.results) ? geo.results.map(r=>({ name:r.name, admin1:r.admin1||'', country:r.country||r.country_code||'', cc:r.country_code||'', lat:r.latitude, lon:r.longitude, timezone:r.timezone })) : [];
      state.acResults = list;
      ac.innerHTML = list.map((r,i)=>`
        <div class="ac-item" data-i="${i}">
          <div><div class="ac-name">${r.cc?flag(r.cc):'🌍'} ${escapeHTML(r.name)}</div>
          <div class="ac-sub">${escapeHTML(([r.admin1, r.country].filter(Boolean).join(', ')))}</div></div>
          <div class="ac-sub">lat ${r.lat.toFixed(2)}, lon ${r.lon.toFixed(2)}</div>
        </div>`).join('');
      $$('#ac .ac-item').forEach(el=> el.onclick = ()=> pickPlace(Number(el.dataset.i)));
      ac.classList.add('show');
    }catch{ state.acResults=[]; ac.classList.remove('show'); }
  }
  function pickPlace(i){
    const r = state.acResults[i]; if(!r) return;
    state.place = { name:r.name, country:r.cc||r.country, admin1:r.admin1||'', lat:r.lat, lon:r.lon, timezone:r.timezone };
    q.value = r.name + (r.admin1?(', '+r.admin1):'') + (r.country?(', '+r.country):'');
    ac.classList.remove('show'); persist(); fetchAll(); mapCenter(r.lat, r.lon, 8);
  }
  async function onSearch(){
    const termRaw = q.value.trim(); if(!termRaw) return shake(q);
    try{
      const geo = await xfetchJSONStrong('https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(termRaw)+'&count=1&language=hu&format=json');
      if(!geo || !geo.results || !geo.results.length){ toast('Nem található ilyen település.','warn'); return; }
      const r = geo.results[0];
      state.place = { name:r.name, country:r.country_code||r.country, admin1:r.admin1||'', lat:r.latitude, lon:r.longitude, timezone:r.timezone };
      persist(); fetchAll(); mapCenter(state.place.lat, state.place.lon, 8);
    }catch{ toast('Keresés közben hiba történt.','err'); }
  }
  async function useGeolocation(){
    if(!navigator.geolocation){ toast('A böngésző nem támogatja a helymeghatározást.','warn'); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      try{
        const j = await xfetchJSONStrong(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=hu&format=json`);
        const g = (j && j.results && j.results[0]) || {};
        state.place = { name:g.name||'Jelenlegi hely', country:g.country_code||g.country||'', admin1:g.admin1||'', lat, lon, timezone:g.timezone||'auto' };
      }catch{
        state.place = { name:'Jelenlegi hely', country:'', admin1:'', lat, lon, timezone:'auto' };
      }
      persist(); fetchAll(); mapCenter(lat, lon, 8);
    }, ()=> toast('Nem sikerült lekérni a helyzeted.','warn'), { enableHighAccuracy:false, timeout:10000, maximumAge:60000 });
  }

  /* ========= 6) OPEN-METEO + OFFLINE ========= */
  async function fetchAll(){
    if(!state.place){ toast('Nincs hely kiválasztva.','warn'); return; }
    skeleton(true); showOffline(false);
    const { lat, lon } = state.place;
    const timezone = state.place.timezone || 'auto';
    const tempUnit = state.units==='metric'?'celsius':'fahrenheit';
    const windUnit = state.units==='metric'?'kmh':'mph';

    const paramsFull = {
      latitude: lat, longitude: lon, timeformat:'iso8601', timezone,
      temperature_unit: tempUnit, wind_speed_unit: windUnit, forecast_days: 7, past_days: 0,
      models: 'best_match',
      current: [
        'temperature_2m','relative_humidity_2m','apparent_temperature',
        'is_day','weather_code','surface_pressure','wind_speed_10m'
      ].join(','),
      hourly: [
        'temperature_2m','weather_code','wind_speed_10m',
        'precipitation','precipitation_probability','rain','showers','snowfall'
      ].join(','),
      daily: [
        'weather_code','temperature_2m_max','temperature_2m_min',
        'sunrise','sunset','precipitation_sum','precipitation_probability_max','wind_speed_10m_max'
      ].join(',')
    };

    try{
      let data = await fetchOpenMeteo(paramsFull);
      const hourlyMissing = !data.hourly || !Array.isArray(data.hourly.time) || !data.hourly.time.length;
      const dailyMissing  = !data.daily  || !Array.isArray(data.daily.time)  || !data.daily.time.length;

      if(hourlyMissing || dailyMissing){
        const paramsLight = {
          latitude: lat, longitude: lon, timeformat:'iso8601', timezone,
          temperature_unit: tempUnit, wind_speed_unit: windUnit, forecast_days: 7, past_days: 0,
          models: 'best_match',
          current: 'temperature_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,surface_pressure,relative_humidity_2m',
          hourly: 'temperature_2m,weather_code,wind_speed_10m,precipitation',
          daily: 'weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum,wind_speed_10m_max'
        };
        data = await fetchOpenMeteo(paramsLight);
      }

      state.data = data;
      state.tz = data.timezone || timezone;
      state.offline = false;
      saveDataCache({ place:state.place, payload:data, ts:Date.now(), units:state.units });
      renderAll();
      skeleton(false);
      toast('Frissítve.','ok',1200);
    }catch(err){
      console.error('Open-Meteo hiba, cache használat:', err);
      const cached = loadDataCache();
      if(cached){
        state.data = cached.payload;
        state.tz = cached.payload.timezone || timezone;
        state.offline = true;
        renderAll();
        skeleton(false);
        showOffline(true);
        toast('Offline cache-ből megjelenítve.','warn');
      }else{
        skeleton(false);
        $('#hourly').innerHTML = '<div class="muted small" style="padding:8px">Nincs órás adat.</div>';
        $('#daily').innerHTML  = '<div class="muted small" style="padding:8px">Nincs napi adat.</div>';
        toast('Nem sikerült lekérni az előrejelzést. Nincs offline mentés.','err');
      }
    }
  }

  async function fetchOpenMeteo(params){
    const url = 'https://api.open-meteo.com/v1/forecast?' + new URLSearchParams(params).toString();
    return await xfetchJSONStrong(url);
  }

  /* ========= 7) RENDER + ANIMÁLT IKONOK ========= */
  function renderAll(){
    const place = state.place, data = state.data; if(!place||!data) return;

    $('#place').textContent = [place.name, place.admin1, place.country].filter(Boolean).join(', ');
    $('#tz').textContent = (data.timezone || place.timezone || 'helyi idő').replace('_',' ');
    $('#updated').textContent = state.offline ? 'Utolsó mentett adatok' : 'Most frissítve';

    const c = data.current || {};
    const d0 = data.daily || {};
    const isDay = !!c.is_day;

    $('#currentIcon').innerHTML = animatedIcon(c.weather_code, isDay, 92);
    $('#temp').textContent = safeRound(c.temperature_2m) + '°';
    $('#desc').textContent = describeWMO(c.weather_code);
    $('#feels').textContent = safeRound(c.apparent_temperature) + '°';
    $('#humidity').textContent = (c.relative_humidity_2m!=null?c.relative_humidity_2m+'%':'—');
    $('#wind').textContent = safeRound(c.wind_speed_10m) + (state.units==='metric'?' km/h':' mph');
    $('#pressure').textContent = safeRound(c.surface_pressure) + ' hPa';
    if(d0.sunrise && d0.sunrise.length){ $('#sunrise').textContent = formatTime(d0.sunrise[0]); }
    if(d0.sunset && d0.sunset.length){ $('#sunset').textContent  = formatTime(d0.sunset[0]); }

    // ÓRÁS – 24 elem
    const H = data.hourly || {};
    if(H.time && H.time.length){
      const nowIso = (data.current && data.current.time) ? data.current.time : new Date().toISOString();
      let start = nearestIndex(H.time, nowIso);
      let end = Math.min(start + 24, H.time.length);
      if(end <= start){ start = Math.max(0, H.time.length-24); end = H.time.length; }
      const tiles = [];
      for(let i=start; i<end; i++){
        const ht = H.time[i];
        const isD = (d0.sunrise && d0.sunrise[0] && d0.sunset && d0.sunset[0]) ? guessIsDay(ht, d0.sunrise[0], d0.sunset[0]) : true;
        tiles.push('<div class="tile" title="'+new Date(ht).toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'})+'">'+
          animatedIcon(H.weather_code?H.weather_code[i]:null, isD, 40)+
          '<div><strong>'+safeRound(H.temperature_2m && H.temperature_2m[i])+'°</strong></div>'+
          '<div class="muted small">'+new Date(ht).toLocaleTimeString('hu-HU',{hour:'2-digit',minute:'2-digit'})+'</div>'+
          '<div class="muted small">'+((H.precipitation_probability && H.precipitation_probability[i]!=null)?('Csap.: '+H.precipitation_probability[i]+'%'):'\u00A0')+'</div>'+
          '<div class="muted small">Szél: '+safeRound(H.wind_speed_10m && H.wind_speed_10m[i])+' '+(state.units==='metric'?'km/h':'mph')+'</div>'+
        '</div>');
      }
      $('#hourly').innerHTML = tiles.join('') || '<div class="muted small" style="padding:8px">Nincs órás adat.</div>';
      $('#hourlyRange').textContent = (H.time[start]?formatTime(H.time[start]):'—') + ' – ' + (H.time[end-1]?formatTime(H.time[end-1]):'—');
    }else{
      $('#hourly').innerHTML = '<div class="muted small" style="padding:8px">Nincs órás adat.</div>';
    }

    // NAPI – 7 nap
    if(d0.time && d0.time.length){
      const rows = [];
      for(let j=0;j<d0.time.length;j++){
        rows.push('<div class="dayrow">'+
          '<div class="row" style="display:flex; gap:12px">'+
            animatedIcon(d0.weather_code?d0.weather_code[j]:null, true, 26)+
            '<div><strong>'+new Date(d0.time[j]).toLocaleDateString('hu-HU',{weekday:'long'})+'</strong>'+
            '<div class="muted small">'+new Date(d0.time[j]).toLocaleDateString('hu-HU',{month:'long',day:'2-digit'})+'</div></div>'+
          '</div>'+
          '<div class="muted small">'+((d0.precipitation_probability_max && d0.precipitation_probability_max[j]!=null)?('Csap.: '+d0.precipitation_probability_max[j]+'%'):'—')+'</div>'+
          '<div class="row" style="display:flex; align-items:center; gap:6px"><strong>'+safeRound(d0.temperature_2m_max && d0.temperature_2m_max[j])+'°</strong> <span class="muted">/</span> <span class="muted">'+safeRound(d0.temperature_2m_min && d0.temperature_2m_min[j])+'°</span></div>'+
          '<div class="muted small">Szél: '+safeRound(d0.wind_speed_10m_max && d0.wind_speed_10m_max[j])+' '+(state.units==='metric'?'km/h':'mph')+'</div>'+
        '</div>');
      }
      $('#daily').innerHTML = rows.join('');
      $('#dailyRange').textContent = niceDate(d0.time[0]) + ' – ' + niceDate(d0.time[d0.time.length-1]);
    }else{
      $('#daily').innerHTML = '<div class="muted small" style="padding:8px">Nincs napi adat.</div>';
    }

    // radar újrarajzolása
    resizeCanvases(); drawBase(); drawRadar();
  }

  /* ========= 8) ANIMÁLT IKON RENDER ========= */
  function animatedIcon(wmo, isDay, size){
    const cls = iconClass(wmo, isDay);
    const s = size||48;
    const sun = `<g class="ico-sun ${cls}">
      <circle cx="12" cy="12" r="4" fill="currentColor" opacity="0.95"/>
      <g class="rays" stroke="currentColor" stroke-width="2">
        ${Array.from({length:8}).map((_,i)=>{
          const a = i*45, x1=12+7*Math.cos(a*Math.PI/180), y1=12+7*Math.sin(a*Math.PI/180),
                x2=12+10*Math.cos(a*Math.PI/180), y2=12+10*Math.sin(a*Math.PI/180);
          return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" />`;
        }).join('')}
      </g>
    </g>`;
    const cloud = `<g class="ico-cloud ${cls}">
      <path class="cloud" fill="currentColor" d="M7 16a3 3 0 1 1 0-6c.9 0 1.7.4 2.3 1.1A4.5 4.5 0 0 1 17 9.5a4.5 4.5 0 0 1 0 9H7z"/>
    </g>`;
    const rain = `<g class="ico-rain ${cls}">
      ${cloud}
      ${[8,12,16].map((x,i)=>`<path class="drop" d="M${x} 17 l1.5 3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" style="animation-delay:${i*0.25}s"/>`).join('')}
    </g>`;
    const snow = `<g class="ico-snow ${cls}">
      ${cloud}
      ${[8,12,16].map((x,i)=>`<path class="flake" d="M${x} 18 l0 2 M${x-1} 19 l2 0 M${x-1} 18.5 l2 1 M${x-1} 19.5 l2 -1"
         stroke="currentColor" stroke-width="1.2" stroke-linecap="round" style="animation-delay:${i*0.35}s"/>`).join('')}
    </g>`;
    const mist = `<g class="ico-mist ${cls}">
      <rect class="band" x="3" y="10" width="18" height="1.2" fill="currentColor" opacity=".8"/>
      <rect class="band" x="3" y="13" width="18" height="1.2" fill="currentColor" opacity=".7" style="animation-delay:.4s"/>
      <rect class="band" x="3" y="16" width="18" height="1.2" fill="currentColor" opacity=".6" style="animation-delay:.8s"/>
    </g>`;
    const thunder = `<g class="ico-thunder ${cls}">
      ${cloud}
      <path class="bolt" d="M12 12 l3 -5 h-2 l1 -3 l-3 5 h2 z" fill="currentColor" opacity=".7"/>
    </g>`;
    const partly = `<g class="${cls}">${sun}<g transform="translate(5,4)">${cloud}</g></g>`;
    const night = `<g class="${cls}"><path d="M14.5 5.5a6 6 0 1 0 4 9.5a6.5 6.5 0 1 1 -4-9.5z" fill="currentColor" opacity=".95"/></g>`;

    let body = cloud;
    if(wmo===0) body = isDay? sun : night;
    else if(wmo===1||wmo===2) body = partly;
    else if(wmo===3) body = cloud;
    else if(wmo===45||wmo===48) body = mist;
    else if([51,53,55,56,57].includes(wmo)) body = rain;
    else if([61,63,65,66,67,80,81,82].includes(wmo)) body = rain;
    else if([71,73,75,77,85,86].includes(wmo)) body = snow;
    else if([95,96,99].includes(wmo)) body = thunder;

    return `<svg width="${s}" height="${s}" viewBox="0 0 24 24" aria-hidden="true">${body}</svg>`;
  }
  function iconClass(wmo,isDay){
    if(wmo==null) return 'wc-cloud';
    if(wmo===0) return isDay?'wc-sun':'wc-night';
    if(wmo===1||wmo===2) return 'wc-partly';
    if(wmo===3) return 'wc-cloud';
    if(wmo===45||wmo===48) return 'wc-mist';
    if([51,53,55,56,57].includes(wmo)) return 'wc-shower';
    if([61,63,65,66,67,80,81,82].includes(wmo)) return 'wc-rain';
    if([71,73,75,77,85,86].includes(wmo)) return 'wc-snow';
    if([95,96,99].includes(wmo)) return 'wc-thunder';
    return 'wc-cloud';
  }

  /* ========= 9) RADAR (CANVAS) ========= */
  const mapEl = $('#map'), baseCanvas = $('#baseCanvas'), radarCanvas = $('#radarCanvas'), dotsEl = $('#dots'), timeLabel = $('#timeLabel');
  const bctx = baseCanvas.getContext('2d'), rctx = radarCanvas.getContext('2d');
  const TILE = 256;
  const osmURL = (z,x,y)=>`https://tile.openstreetmap.org/${z}/${x}/${y}.png`;
  const radarURL = (ts,z,x,y)=>`https://tilecache.rainviewer.com/v2/radar/${ts}/256/${z}/${x}/${y}/2/1_1.png`;
  const lon2x = (lon,z)=> ((lon+180)/360)*Math.pow(2,z);
  const lat2y = (lat,z)=>{ const r=lat*Math.PI/180, n=Math.pow(2,z); return (1-Math.log(Math.tan(r)+1/Math.cos(r))/Math.PI)/2*n; };
  function mapCenter(lat,lon,z=7){ state.map.z=z; state.map.lon=lon; state.map.lat=lat; drawBase(); drawRadar(); }

  function resizeCanvases(){
    const w = mapEl.clientWidth, h = mapEl.clientHeight, dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
    [baseCanvas, radarCanvas].forEach(c=>{
      c.width = Math.round(w*dpr); c.height = Math.round(h*dpr);
      c.style.width = w+'px'; c.style.height = h+'px';
      const ctx = (c===baseCanvas?bctx:rctx); ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.imageSmoothingEnabled = true; ctx.clearRect(0,0,w,h);
    });
  }
  window.addEventListener('resize', ()=>{ resizeCanvases(); drawBase(); drawRadar(); });

  const imgCache = new Map();
  function loadImg(url){
    return new Promise((res,rej)=>{
      if(imgCache.has(url)){
        const im=imgCache.get(url);
        if(im.complete) return res(im);
        return im.addEventListener('load',()=>res(im),{once:true});
      }
      const im = new Image(); im.crossOrigin='anonymous'; im.referrerPolicy='no-referrer';
      im.onload=()=>{ imgCache.set(url, im); res(im); };
      im.onerror=rej; im.src=url; imgCache.set(url, im);
    });
  }

  function eachVisibleTiles(cb){
    const {z, lon, lat} = state.map;
    const w = mapEl.clientWidth, h = mapEl.clientHeight;
    const cx = lon2x(lon,z), cy = lat2y(lat,z);
    const tilesX = Math.ceil(w/TILE)+2, tilesY = Math.ceil(h/TILE)+2;
    const startX = Math.floor(cx-tilesX/2), startY = Math.floor(cy-tilesY/2);
    const offsetX=(startX-cx)*TILE + w/2, offsetY=(startY-cy)*TILE + h/2;
    for(let i=0;i<tilesX;i++){
      for(let j=0;j<tilesY;j++){
        let x=startX+i, y=startY+j, max=Math.pow(2,z);
        let wrappedX=((x%max)+max)%max; if(y<0||y>=max) continue;
        const dx = Math.floor(offsetX + i*TILE), dy = Math.floor(offsetY + j*TILE);
        cb({z, x:wrappedX, y, dx, dy});
      }
    }
  }

  function drawBase(){
    const w = mapEl.clientWidth, h = mapEl.clientHeight;
    bctx.clearRect(0,0,w,h);
    eachVisibleTiles(({z,x,y,dx,dy})=>{
      const url = osmURL(z,x,y);
      loadImg(url).then(im=>{
        bctx.drawImage(im, 0,0,TILE,TILE, dx-0.5, dy-0.5, TILE+1, TILE+1);
      }).catch(()=>{ /* ignore */ });
    });
  }

  const radar = state.radar;
  async function loadFrames(){
    try{
      const j = await xfetch('https://api.rainviewer.com/public/weather-maps.json').then(r=>r.json());
      const past = j && j.radar && j.radar.past ? j.radar.past : [];
      const nowc = j && j.radar && j.radar.nowcast ? j.radar.nowcast : [];
      radar.frames = past.concat(nowc);
      if(!radar.frames.length) throw new Error('no-frames');
      radar.idx = radar.frames.length-1; buildTimeline(); drawRadar(); play();
    }catch{ toast('Nem sikerült betölteni a radart.','warn'); }
  }
  function buildTimeline(){
    dotsEl.innerHTML='';
    radar.frames.forEach((_,i)=>{
      const d=document.createElement('div'); d.className='dot'+(i===radar.idx?' active':'');
      d.title=new Date(radar.frames[i].time*1000).toLocaleString('hu-HU');
      d.onclick=()=>{ radar.idx=i; drawRadar(); pause(); };
      dotsEl.appendChild(d);
    });
  }
  function highlightDot(){ [...dotsEl.children].forEach((el,i)=>el.classList.toggle('active', i===radar.idx)); }

  function drawRadar(){
    const w = mapEl.clientWidth, h = mapEl.clientHeight;
    rctx.clearRect(0,0,w,h);
    if(!radar.frames.length) return;
    const fr = radar.frames[radar.idx];
    eachVisibleTiles(({z,x,y,dx,dy})=>{
      const url = radarURL(fr.time, z, x, y);
      loadImg(url).then(im=>{
        rctx.drawImage(im, 0,0,TILE,TILE, dx-0.5, dy-0.5, TILE+1, TILE+1);
      }).catch(()=>{ /* ignore */ });
    });
    const dt = new Date(fr.time*1000);
    timeLabel.textContent = dt.toLocaleString('hu-HU',{hour:'2-digit',minute:'2-digit',month:'short',day:'2-digit'});
    highlightDot();
  }

  function step(dir=1){ if(!radar.frames.length) return; radar.idx=(radar.idx+dir+radar.frames.length)%radar.frames.length; drawRadar(); }
  function play(){ pause(); radar.playing=true; radar.timer=setInterval(()=>step(1), 800); }
  function pause(){ radar.playing=false; if(radar.timer){ clearInterval(radar.timer); radar.timer=null; } }
  $('#radarPlay').onclick = play; $('#radarPause').onclick = pause; $('#radarNow').onclick = ()=>{ radar.idx=Math.max(0,radar.frames.length-1); drawRadar(); };

  $('#zoomIn').onclick = ()=>{ state.map.z = Math.min(12, state.map.z+1); drawBase(); drawRadar(); };
  $('#zoomOut').onclick = ()=>{ state.map.z = Math.max(2, state.map.z-1); drawBase(); drawRadar(); };
  $('#locate').onclick = ()=>{ if(state.place) mapCenter(state.place.lat, state.place.lon, Math.max(8,state.map.z)); };
  mapEl.addEventListener('pointerdown', e=>{ state.map.dragging=true; state.map.last={x:e.clientX,y:e.clientY}; mapEl.setPointerCapture(e.pointerId); });
  mapEl.addEventListener('pointermove', e=>{
    if(!state.map.dragging) return;
    const dx=e.clientX-state.map.last.x, dy=e.clientY-state.map.last.y;
    state.map.last={x:e.clientX,y:e.clientY};
    const worldW = TILE*Math.pow(2,state.map.z);
    const lonPerPx = 360/worldW, latPerPx = 360/worldW;
    state.map.lon -= dx*lonPerPx; state.map.lat += dy*latPerPx;
    drawBase(); drawRadar();
  });
  mapEl.addEventListener('pointerup', ()=>{ state.map.dragging=false; });
  mapEl.addEventListener('wheel', e=>{ e.preventDefault(); const d=Math.sign(e.deltaY); state.map.z=Math.min(12,Math.max(2,state.map.z-d)); drawBase(); drawRadar(); }, {passive:false});

  // init
  resizeCanvases(); drawBase(); loadFrames();

  /* ========= 10) KIS SEGÉDEK ========= */
  function persist(){ localStorage.setItem('weather:last', JSON.stringify({ units:state.units, place:state.place })); }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function flag(cc){ if(!cc) return '🌍'; const u=String(cc).toUpperCase(); return String.fromCodePoint(0x1F1E6+u.charCodeAt(0)-65, 0x1F1E6+u.charCodeAt(1)-65); }
  function safeRound(x){ const n=Number(x); return isFinite(n)?Math.round(n):'—'; }
  function shake(input){ const el = input.closest('.search'); el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:260}); input.focus(); }
  function pad(n){ return n<10?'0'+n:n; }
  function formatTime(s){ const d=new Date(s); return pad(d.getHours())+':'+pad(d.getMinutes()); }
  function niceDate(s){ const d=new Date(s); return d.toLocaleDateString('hu-HU',{month:'short',day:'2-digit',weekday:'short'}); }
  function nearestIndex(arr, iso){ const now=+new Date(iso); let i=-1; for(let k=0;k<arr.length;k++){ if(+new Date(arr[k])>=now){ i=k; break; } } return i<0?0:i; }
  function guessIsDay(iso, sr, ss){ const t=+new Date(iso), a=+new Date(sr), b=+new Date(ss); return t>=a && t<b; }
  function showOffline(v){ OFFLINE_BADGE.classList.toggle('show', !!v); }
  function skeleton(active){ $('#updated').textContent = active ? 'Frissítés…' : (state.offline?'Utolsó mentett adatok':'Most frissítve'); }
  function toast(msg, kind='ok', ms=1800){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position='fixed'; el.style.left='50%'; el.style.bottom='22px'; el.style.transform='translateX(-50%)';
    el.style.background= kind==='ok'? '#10b981' : kind==='warn'? '#f59e0b' : '#ef4444';
    el.style.color='#001018'; el.style.padding='10px 14px'; el.style.borderRadius='999px'; el.style.boxShadow='0 10px 30px rgba(0,0,0,.35)'; el.style.fontWeight='700';
    el.style.zIndex=9999; el.style.opacity='0'; el.style.transition='opacity .2s ease';
    document.body.appendChild(el); requestAnimationFrame(()=> el.style.opacity='1');
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),200); }, ms);
  }

})(); // IIFE
</script>
</body>
</html>
